#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "../../include/hpdf/hpdf.h"

typedef struct {
    char *content;
    size_t cap;
} StubDoc;

static void ensure_capacity(StubDoc *d, size_t extra) {
    if (!d) return;
    size_t need = (d->content ? strlen(d->content) : 0) + extra + 1;
    if (d->cap >= need) return;
    size_t ncap = d->cap ? d->cap*2 : 4096;
    while (ncap < need) ncap *= 2;
    d->content = realloc(d->content, ncap);
    if (!d->content) { d->cap = 0; return; }
    d->cap = ncap;
}

HPDF_Doc HPDF_New(HPDF_Error_Handler user_error_fn, void *user_data) {
    (void)user_error_fn; (void)user_data;
    StubDoc *d = (StubDoc*)calloc(1, sizeof(StubDoc));
    if (!d) return NULL;
    d->content = NULL; d->cap = 0;
    return (HPDF_Doc)d;
}

void HPDF_Free(HPDF_Doc pdf) {
    if (!pdf) return;
    StubDoc *d = (StubDoc*)pdf;
    free(d->content);
    free(d);
}

HPDF_Page HPDF_AddPage(HPDF_Doc pdf) {
    if (!pdf) return NULL;
    StubDoc *d = (StubDoc*)pdf;
    ensure_capacity(d, 128);
    if (!d->content) { d->content = strdup("\n-- PAGE START --\n"); d->cap = strlen(d->content)+1; }
    else strcat(d->content, "\n-- PAGE START --\n");
    return (HPDF_Page)pdf;
}

HPDF_STATUS HPDF_Page_SetSize(HPDF_Page page, HPDF_PageSizes size, HPDF_PageDirection direction) {
    (void)page; (void)size; (void)direction; /* no-op */
    return 0;
}

HPDF_Font HPDF_GetFont(HPDF_Doc pdf, const char *fontname, const char *encoding_name) {
    (void)pdf; (void)encoding_name; return (HPDF_Font)strdup(fontname);
}

HPDF_STATUS HPDF_Page_SetFontAndSize(HPDF_Page page, HPDF_Font font, HPDF_REAL size) {
    StubDoc *d = (StubDoc*)page;
    ensure_capacity(d, 256);
    char buf[256];
    snprintf(buf, sizeof(buf), "[Font: %s Size: %.1f]\n", (char*)font, (double)size);
    if (d->content) strcat(d->content, buf);
    return 0;
}

HPDF_STATUS HPDF_Page_BeginText(HPDF_Page page) { (void)page; return 0; }
HPDF_STATUS HPDF_Page_EndText(HPDF_Page page) { (void)page; return 0; }

HPDF_STATUS HPDF_Page_TextOut(HPDF_Page page, HPDF_REAL xpos, HPDF_REAL ypos, const char *text) {
    StubDoc *d = (StubDoc*)page;
    ensure_capacity(d, strlen(text) + 64);
    char buf[512];
    snprintf(buf, sizeof(buf), "(Text at %.1f,%.1f) %s\n", (double)xpos, (double)ypos, text);
    if (d->content) strcat(d->content, buf);
    return 0;
}

HPDF_STATUS HPDF_SaveToFile(HPDF_Doc pdf, const char *file_name) {
    if (!pdf || !file_name) return (HPDF_STATUS)-1;
    StubDoc *d = (StubDoc*)pdf;
    FILE *f = fopen(file_name, "w");
    if (!f) return (HPDF_STATUS)-1;
    fprintf(f, "-- Simulated PDF output generated by HPDF stub --\n\n");
    if (d->content) fprintf(f, "%s\n", d->content);
    fclose(f);
    return 0;
}

// Minimal implementations for other symbols used
HPDF_STATUS HPDF_Page_SetWidth(HPDF_Page p, HPDF_REAL w) { (void)p; (void)w; return 0; }

// Provide HPDF_GetVersion
const char *HPDF_GetVersion(void) { return "stub-0.0"; }
